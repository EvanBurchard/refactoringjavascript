<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Refactoring JavaScript</title>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script>
    <link rel="stylesheet" type="text/css" href="theme/html/html.css">
  </head>
  <body data-type="book">
    <section data-type="preface" id="_preface">
<h1>Preface</h1>

<p>Welcome to <em>Refactoring JavaScript</em>. Throughout this book, we'll be looking at ways to write better JavaScript, drawing inspiration from classical refactoring techniques while exploring various styles of coding.</p>

<section data-type="sect1" id="why-this-book-exists-3mfwCA">
<h1>Why This Book Exists</h1>

<p>Like it or not, JavaScript is not going away. No matter what framework or "compiles-to-js" language or library you use, bugs and performance concerns will always be an issue if the underlying quality of your JavaScript is poor. Rewrites, including porting to the framework of the month are terribly expensive and unpredictable. The bugs won’t magically go away, and can happily reproduce themselves in a new context. To complicate things further, features will get dropped, at least temporarily.</p>

<p>This book provides clear guidance on how best to avoid these pathological approaches to writing JavaScript. Bad code doesn’t have to stay that way. And making it better doesn’t have to be intimidating or unreasonably expensive.&nbsp;</p>
</section>

<p>&nbsp;</p>

<section data-type="sect1" id="who-this-book-is-for-jPf0Fr">
<h1>Who This Book Is For</h1>

<p>This book is meant for programmers who have some experience writing bad code, and an interest in writing better code. It's for those writing JavaScript on the front-end or the back-end. It's for those writing JavaScript by choice as well as those who are "stuck with it" due to JavaScript's monopoly of the browser platform.</p>

<p>If you're an absolute beginner, you might want to write some bad code for a couple months first. If you're not interested in writing better code, you might not have the patience for this book. If neither of those situations describes you, we're good to go.</p>

<p>Interestingly enough, there are numerous efforts working to make JavaScript better, while at the same time others aim to make it obsolete. The number of ways to write good and bad JavaScript continues to expand. Frameworks can go a long way toward handling complexity, but programmers constrained by frameworks will be limited. If you find that you (or your codebase) are struggling to work outside of a framework (or at some of the more confusing edges of it), this book should give you new ideas in how to approach your work.</p>

<p>If you have trouble testing, debugging, or having confidence in your codebase, this book should be helpful.</p>

<p>Most of us don't work on perfect codebases, especially in JavaScript, where engineers might primarily use Ruby, Python, Java, etc. What this book does is help you identify what specific parts of a codebase are bad, while providing a multitude of options for improvement.</p>
</section>

<p>&nbsp;</p>

<section data-type="sect1" id="how-to-use-this-book-2vfWUR">
<h1>How To Use This Book</h1>

<p>Chapters 1-5 describe the interplay between JavaScript, refactoring, quality, confidence and testing. In many books, it is common to tack on testing to the end. In this book, for the types of code we are exploring, this wouldn't be appropriate. Testing is essential for confidence. Confidence is essential to refactoring. Refactoring is essential to quality, which is the goal.</p>

<pre data-type="programlisting">
testing -&gt; confidence -&gt; refactoring -&gt; quality
</pre>

<p>JavaScript (and its ecosystem) happens to provide the space in which that transformation takes place, so those chapters necessarily include an exploration of the language itself. If you're completely comfortable with the transformation described above, it's possible that you might want to skim or skip these chapters. Although that is not recommended, it is your book, so you can use it however you want. If it's best use is as a doorstop or to start a fire for warmth or as a sacrifice of some sort, go for it. It's your book. If you find an unconventional use for the book, email me a picture or video. I'm at http://evanburchard.com/contact or @evanburchard on Twitter and GitHub.</p>

<div data-type="note" id="can-i-burn-or-doorstopify-digital-copies-too-9QuoF1UE"><h6>Note</h6>
<h1>Can I Burn or Doorstopify Digital Copies Too?</h1>

<p>Unfortunately, no. HOWEVER, what you can do is send them to your friends. Since this book is under a Creative Commons license, you're free to share a PDF, for example.</p>

<p>Also, you can always find an HTML version at http://refactoringjs.com.</p>
</div>

<p>After Chapter 5, things get harder, especially if you skipped 1-5. There's more code to write and follow along with. In Chapters 6 and 7, we go through refactoring functions and objects, and we don't shy away from some of the more complicated bits of JavaScript. Generally, the goal of these chapters is to provide options for improving code without radically changing the interface. Through applying techniques found in these two chapters, you'll be able to turn a mess of a codebase into one that has a decent baseline of quality.&nbsp;</p>

<p>Chapter 8 expands our view of architecture to those that include (or avoid) hierarchies.</p>

<p>Chapters 9, 10 and 11 are dedicated to specific topics (Design Patterns, Asynchronous Programming, and Functional Programming) that can take your code beyond that baseline, but necessarily involve more aggressive changes. With the design patterns in Chapter 9, we recognize ways to extend and draw from JavaScript's object-oriented side, as well a historical connection between refactoring and OOP. With Chapter 10, we deal with the reality that many JavaScript codebases have more than one thing to do at once. In Chapter 11, we take a tour of functional programming through a couple of libraries that provide useful interfaces which go beyond those that our standard Array functions (<code>forEach</code>, <code>map</code>, <code>reduce</code>, etc.) give us.</p>

<p>In some sense, those last three chapters in particular break away from our initial goal to refactor by changing the <em>implementation details</em> without changing the <em>interface</em>. On the other hand, these interfaces are both useful and sometimes unavoidable. We could easily find wanting to write that is necessarily asynchronous for performance reasons. Or we could find ourselves "stuck" in a codebase that has much invested in <em>good or bad</em> attempts at OOP or FP. So either through our choice or by what we inherit, these are parts of JavaScript that we should pay attention to and be able to improve upon. If you adopt a completely different paradigm to a codebase, it is unlikely that you'll be "refactoring" in the sense that we mean throughout most of the book.</p>

<p>If we want to be rigid about it, these chapters still refactor <em>within</em> their paradigms (OOP to better OOP, async to better async, and FP to better FP), and if we wish to think in the broadest terms about the execution of our program (e.g. "running <strong><code>node <em>myprogram.js</em></code></strong>" as <em>input</em> and "being satisfied with how it ran" as <em>output</em>) then we can be refactoring even while jumping from paradigm to paradigm. I encourage you to first work with a narrower sense of smaller, incremental changes that are easy to test and be confident in.</p>

<p>To quote William Opdyke's original thesis on refactoring:</p>

<blockquote>
<div data-canvas-width="750.2574999999997">This definition of semantic equivalence allows changes throughout the program, as long as this mapping of input to output values remains the same. Imagine that a <span class="highlight selected">circle</span> is drawn around the parts of a program affected by a refactoring. The behavior as viewed from outside the circle does not change. For some refactorings, the circle surrounds most or all of the program. For example, if a variable is referenced throughout a program, the refactoring that changes its name will affect much of the program. For other refactorings, the circle covers a much smaller area;</div>

<div data-canvas-width="141.12724999999998">for example, only part of one function body is effected when a particular function call contained in it is inline expanded. In both cases, the key idea is that the results (including side effects) of operations invoked and references made from outside the circle do not change, as viewed from outside the circle.</div>
</blockquote>

<p>Although we're free to draw "the circle" as large as we'd like, it's very common for the term "refactoring" to get thrown around to simply mean "changing code." As we discuss in Chapter 1, it is not. That is easier to see on a small scale, like the ones that we spend the most pages on. Think of Chapters 8, 9, and 10 first as architectural options, and second as possibilities for creating better code (safely and incrementally) within those options. As an example, if someone says something about "<em>Refactoring</em> to use asynchronous code" it is likely too broad of a problem to execute in a safe and incremental way. But if you want to think of Chapter 9 as giving you the power to do so, I can't stop you. It's your book now. You can draw "the circle" as large as you want.</p>

<p>If you find any of the tools or concepts confusing, you will probably find the Appendix helpful. If you are looking for code samples and other information on the book's <a href="http://refactoringjs.com">website</a>. You can also find an HTML version there if you prefer to read that way.</p>

<p>So in summary, use this book to learn about:</p>

<ul>
	<li>refactoring</li>
	<li>testing</li>
	<li>JavaScript</li>
	<li>refactoring and testing JavaScript</li>
	<li>a few JavaScript paradigms</li>
	<li>refactoring and testing within those JavaScript paradigms</li>
</ul>

<p>Alternatively (under adult supervision of course), the paper versions can be set on fire and used for:</p>

<ul>
	<li>warmth</li>
	<li>protest</li>
	<li>ritual tech book sacrifices</li>
</ul>

<p>The digital copies can get passed around in accordance with the Creative Commons license restrictions.</p>

<p class="link">If you have any problems, questions, complaints or compliments, feel free to reach out to me through <a href="http://evanburchard.com/contact">my website</a>.</p>

<p>&nbsp;</p>
</section>

<section data-type="sect1" id="some-words-in-this-book-nPfXcN">
<h1>Some Words in This Book</h1>

<section data-type="sect2" id="app-application-program-W5fvTocw">
<h2>App, application, program</h2>

<p>Some words in this book are imprecise. "App," "application," "program," and "website" are interchangeable much of the time. In case there is any confusion, this book describes general principles for improving the quality of JavaScript, so none of those terms should be taken too literally. Maybe your code is a library or framework? In any case, the techniques in this book should apply just fine.</p>
</section>

<section data-type="sect2" id="inclusivity-through-words-and-diagrams-y5f4CNcZ">
<h2>Inclusivity Through Words and Diagrams</h2>

<p>Some words in this book may not feel inclusive to everyone. I tried to balance the use of "he" and "she," which I realize isn't everyone's preference. Some people might advocate for "they" or other less common singular 3rd person pronouns. Others might go for always using "she." If you are feeling up for it and have any thoughts on how I might improve on this aspect in the future, please <a href="http://evanburchard.com/contact">let me know</a>.</p>

<p>Additionally, I am realizing (too late) that my reliance on diagrams, especially those in Chapter 5, may do a terrible disservice to readers with a visual impairment. If you feel like you've missed out on any content for this reason, please feel free to reach out to me with any questions <a href="http://evanburchard.com/contact">here</a>.</p>
</section>

<section data-type="sect2" id="users-g2fEhKcL">
<h2>Users</h2>

<p>There's also one word in this book I really hate, and that's "users." It's imprecise and also creates some distance between the creators (developers/designers) and consumers (users). More precise and charitable words are often specific to the problem domain, or else we're stuck with terms like "people" or "people who use the program/website." If there is no more specific term than "person" or "user," (even including "customer") it might be a hint that the business model is purely based on selling people as data, but that's another discussion.</p>

<p>The point is that that term is used in this book to convey a familiar concept: a person who uses the program/website. Also, there are not yet magnanimous and accurate terms to supplant the related terms of "user experience (UX) or "user interface" (UI). Rather than explaining this in several places or using nonstandard or specific terms for frequently abstract concepts, I chose to save the effort and just talk about it here.</p>

<p>In any case, I fully endorse the following quote (and its implications) by "The Leonardo da Vinci of Data," Edward Tufte:</p>

<blockquote>
<p>There are only two industries that refer to their customers as users: illegal drugs, and software houses.</p>
</blockquote>

<p>There is a movement called "ethical design" which hopefully helps the industry shed this term (and the inconsiderate practices that stem from it) at some point.</p>
</section>

<section data-type="sect2" id="api-interface-implementation-client-code-OzfoFOcV">
<h2>API, interface, implementation, "client code"</h2>

<p>This gets a little murky, but one thing I wish I could highlight more is the hierarchy (not in terms of objects), but in the interface of a well-designed codebase. When a code is a simple script, we expect it to run top to bottom, as a procedure. As a codebase matures (through design, not butchery mixed with entropy), we expect it to develop in 3 main layers (although this is obviously extended in more complex codebases).</p>

<p>The first, is the code behind the scenes, deeper in the codebase, is referred to in this book as the "implementation." For refactoring, the most important distinction is between the implementation and the outer layer. This second layer can be called the "interface" or "API" and describes the "public" functions and objects that one should expect to interact with if a code base was used as a module. The third layer of consequence is sometimes called the "client code" or "calling code." It refers to the code that is written to interact with the "interface" layer. This is the code that people using a module would write, as well as the testing code that we will write to test the interface layer.</p>

<div data-type="note" id="basics-of-architecture-NVuOhAFbcr"><h6>Note</h6>
<h1>Basics of Architecture</h1>

<p>Throughout this book, we're creating programs that start as very unstructured, and our main thrust (regardless of a paradigm like Object-Oriented Programming or Functional Programming) is to make divisions between these three layers. This is what allows code to be testable and portable. If you're mostly reliant on frameworks that provide their own organization, this process might be unfamiliar.</p>
</div>
</section>

<section data-type="sect2" id="inputs-non-local-and-free-variables-ogfXH8cL">
<h2>Inputs (non-local and "free variables")</h2>

<p>Throughout the book (especially in Chapter 5), we distinguish between three types of inputs:</p>

<ul>
	<li>explicit inputs (the parameters passed into a function)</li>
	<li>implicit inputs (the <code>this</code> that refers to the containing context object, function, or class)</li>
	<li>non-local inputs (the values used within a function or object that are defined elsewhere)</li>
</ul>

<p>There are two things of note here. First, local variables (or constants) created within the scope of a function are not considered "inputs" for the sake of diagramming or otherwise. Second, although the term "non-local input" is used as a precise term in this text, "free variable" is a more common name. However, it is a bit imprecise given that non-local inputs may constants rather than variables. Similarly, some use the term "bound variable" to refer to what we call "explicit inputs," and to some degree, "implicit inputs" as well.&nbsp;</p>
</section>
</section>

<section data-type="sect1" id="_conventions_used_in_this_book">
<h1>Conventions Used in This Book</h1>

<p>The following typographical conventions are used in this book:</p>

<dl>
	<dt><em>Italic</em></dt>
	<dd>
	<p>Indicates new terms, URLs, email addresses, filenames, and file extensions. Also used on occassion for emphasis and contrast.</p>
	</dd>
	<dt><code>Constant width</code></dt>
	<dd>
	<p>Used for program listings, as well as within paragraphs to refer to program elements such as variable or function names, databases, data types, environment variables, statements, and keywords.</p>
	</dd>
	<dt><strong><code>Constant width bold</code></strong></dt>
	<dd>
	<p>Shows commands or other text that should be typed literally by the user.</p>
	</dd>
	<dt><em><code>Constant width italic</code></em></dt>
	<dd>
	<p>Shows text that should be replaced with user-supplied values or by values determined by context.</p>
	</dd>
</dl>

<div data-type="tip" id="id-DgurhXSa"><h6>Tip</h6>
<p>This element signifies a tip or suggestion.</p>
</div>

<div data-type="note" id="id-v5udFxSp"><h6>Note</h6>
<p>This element signifies a general note.</p>
</div>

<div data-type="warning" id="id-mquKHXSA"><h6>Warning</h6>
<p>This element indicates a warning or caution.</p>
</div>
</section>

<section data-type="sect1" id="_using_code_examples">
<h1>Using Code Examples</h1>
<!--PROD: Please reach out to author to find out if they will be uploading code examples to oreilly.com or their own site (e.g., GitHub). If there is no code download, delete this whole section. If there is, when you email digidist with the link, let them know what you filled in for title_title (should be as close to book title as possible, i.e., learning_python_2e). This info will determine where digidist loads the files.-->

<p>Supplemental material (code examples, exercises, etc.) is available for download at <a href="https://github.com/oreillymedia/title_title">https://github.com/oreillymedia/title_title</a> or <a href="https://refactoringjs.com">https://refactoringjs.com</a>.</p>

<p>This book is here to help you get your job done. In general, if example code is offered with this book, you may use it in your programs and documentation. You do not need to contact us for permission unless you’re reproducing a significant portion of the code. For example, writing a program that uses several chunks of code from this book does not require permission. Selling or distributing a CD-ROM of examples from O’Reilly books does require permission. Answering a question by citing this book and quoting example code does not require permission. Incorporating a significant amount of example code from this book into your product’s documentation does require permission.</p>

<p>We appreciate, but do not require, attribution. An attribution usually includes the title, author, publisher, and ISBN. For example: “<em>Refactoring JavaScript</em> by Evan Burchard (O’Reilly). Copyright 2017 Some Copyright Holder, 978-0-596-xxxx-x.”</p>

<p>If you feel your use of code examples falls outside fair use or the permission given above, feel free to contact us at <a xmlns="http://www.w3.org/1999/xhtml" class="email" href="mailto:permissions@oreilly.com"><em>permissions@oreilly.com</em></a>.</p>

<p>Tools used within the code of this book can be found in the appendix, along with resources for further information on topics covered. For reference, the tools used in this book along with their versions are:</p>

<ul>
	<li>node 6.7.0</li>
	<li>npm 3.10.3</li>
	<li>wish 0.1.2</li>
	<li>mocha 3.2.0</li>
	<li>deep-equal 1.0.1</li>
	<li>testdouble 1.10.0</li>
	<li>tape 4.6.3</li>
	<li>lodash 4.17.2</li>
	<li>assert 1.4.1</li>
	<li>underscore 1.8.3</li>
	<li>ramda 0.22.1</li>
	<li>sanctuary 0.11.1</li>
</ul>

<p>Later versions are unlikely to cause problems, but earlier ones might. At lower versions, node in particular is known to not fully support the code in this book.</p>
</section>

<section data-type="sect1" id="_safari_books_online">
<h1>Safari® Books Online</h1>

<div class="safarienabled" data-type="note" id="id-Dgu0T0sa"><h6>Note</h6>
<p><a xmlns="http://www.w3.org/1999/xhtml" class="orm:hideurl:ital" href="http://safaribooksonline.com"><em class="hyperlink">Safari Books Online</em></a> is an on-demand digital library that delivers expert <a xmlns="http://www.w3.org/1999/xhtml" class="orm:hideurl" href="https://www.safaribooksonline.com/explore/">content</a> in both book and video form from the world’s leading authors in technology and business.</p>
</div>

<p>Technology professionals, software developers, web designers, and business and creative professionals use Safari Books Online as their primary resource for research, problem solving, learning, and certification training.</p>

<p>Safari Books Online offers a range of <a xmlns="http://www.w3.org/1999/xhtml" class="orm:hideurl" href="https://www.safaribooksonline.com/pricing/">plans and pricing</a> for <a xmlns="http://www.w3.org/1999/xhtml" class="orm:hideurl" href="https://www.safaribooksonline.com/enterprise/">enterprise</a>, <a xmlns="http://www.w3.org/1999/xhtml" class="orm:hideurl" href="https://www.safaribooksonline.com/government/">government</a>, <a xmlns="http://www.w3.org/1999/xhtml" class="orm:hideurl" href="https://www.safaribooksonline.com/academic-public-library/">education</a>, and individuals.</p>

<p>Members have access to thousands of books, training videos, and prepublication manuscripts in one fully searchable database from publishers like O’Reilly Media, Prentice Hall Professional, Addison-Wesley Professional, Microsoft Press, Sams, Que, Peachpit Press, Focal Press, Cisco Press, John Wiley &amp; Sons, Syngress, Morgan Kaufmann, IBM Redbooks, Packt, Adobe Press, FT Press, Apress, Manning, New Riders, McGraw-Hill, Jones &amp; Bartlett, Course Technology, and hundreds <a xmlns="http://www.w3.org/1999/xhtml" class="orm:hideurl" href="https://www.safaribooksonline.com/our-library/">more</a>. For more information about Safari Books Online, please visit us <a xmlns="http://www.w3.org/1999/xhtml" class="orm:hideurl" href="http://safaribooksonline.com/">online</a>.</p>
</section>

<section data-type="sect1" id="_how_to_contact_us">
<h1>How to Contact Us</h1>

<p>Please address comments and questions concerning this book to the publisher:</p>

<ul xmlns="http://www.w3.org/1999/xhtml" class="simplelist">
	<li>O’Reilly Media, Inc.</li>
	<li>1005 Gravenstein Highway North</li>
	<li>Sebastopol, CA 95472</li>
	<li>800-998-9938 (in the United States or Canada)</li>
	<li>707-829-0515 (international or local)</li>
	<li>707-829-0104 (fax)</li>
</ul>

<p>We have a web page for this book, where we list errata, examples, and any additional information. You can access this page at <a href="http://www.oreilly.com/catalog/&lt;catalog page&gt;">http://www.oreilly.com/catalog/&lt;catalog page&gt;</a>.</p>
<!--Don't forget to update the link above.-->

<p>To comment or ask technical questions about this book, send email to <a xmlns="http://www.w3.org/1999/xhtml" class="email" href="mailto:bookquestions@oreilly.com"><em>bookquestions@oreilly.com</em></a>.</p>

<p>For more information about our books, courses, conferences, and news, see our website at <a href="http://www.oreilly.com">http://www.oreilly.com</a>.</p>

<p>Find us on Facebook: <a href="http://facebook.com/oreilly">http://facebook.com/oreilly</a></p>

<p>Follow us on Twitter: <a href="http://twitter.com/oreillymedia">http://twitter.com/oreillymedia</a></p>

<p>Watch us on YouTube: <a href="http://www.youtube.com/oreillymedia">http://www.youtube.com/oreillymedia</a></p>
</section>

<section data-type="sect1" id="_acknowledgments">
<h1>Acknowledgments</h1>

<p>Thanks to my family for their support in making this book happen: Mom, Dad, Amy, Scott, Gretchen, Max, and Jade.</p>

<p>Special thanks to the people who helped kick everything off: Zeke Templin, Steve Souders, Mary Treseler, Simon St. Laurent, and Tyler Ortman.</p>

<p>And to those who gave technical inspiration and feedback: Jacob Barss-Bailey, Matt Blake, Charles Baakel, Stefano De Vuono, and Ryan Duchin.</p>
And the rest of the O'Reilly staff that helped along the way: Annalis Clint, Nena Caviness, Michelle Gilliland, Rita Scordamalgia, Josh Garstka, and especially my editors, Nan Barber and Ally MacDonald.<br>
<br>
And to my technical reviewers: Steve Suering, Shelley Powers, Chris Deely, Darrell Heath, and Jade Applegate.
<p>And to those whose work I found useful and inspirational: William F. Opdyke, Martin Fowler, Kent Beck, John Brant, Erich Gamma, Richard Helm, Ralph Johnson, John Vlissides, Douglas Crockford, Tony Hoare, Alexis Deveria, Addy Osmani, Robert Nystrom, Brian Lonsdorf, Reginald Braithwaite, <span class="a-size-small a-color-secondary">Miran Lipovaca, Kyle Simpson, </span>Tom Stuart, Michael Fogus, David Chambers, Michael Hurley, Scott Sauyet, Yehuda Katz, Jay Fields, Shane Harvie, Russ Olsen, Joshua Kerievsky, <span class="vcard-fullname d-block">James Halliday, TJ Holowaychuk, Justin Searls, Eric Elliot, Jake Archibald, Arnau Sanchez</span>, Alex Chaffee, Eric Hodel, Sean Hussey, Brian Cardarella, Foy Savas, and Katrina Owen, and Bryan Liles.</p>
A special thanks to Dr. Axel Rauschmayer for his amazing work interpreting specs for us mere mortals, as well as providing the foreward to this book.

<div data-type="note" id="psst-hey-reader-p1uwcwtZ"><h6>Note</h6>
<h1>Psst. Hey reader.</h1>

<p>I know it looks like just a big list of names, but the people in this section are all really awesome. The resources in the appendix are less important than this list. A lot of these people made that stuff. And searching their names will let you know about their new stuff, which is probably better than their old stuff. Look these people up.</p>
</div>

<p>And thanks in general to all the people at TC39 and MDN.</p>

<p>And to my dog for taking me on walks, even when I was right in the middle of something.</p>

<p><!--Fill in...-->Also, to you. Thanks for supporting my work. Hit me up if you need anything.</p>
</section>
</section>

  </body>
</html>
